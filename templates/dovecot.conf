# Dovecot configuration template
# Generated by VPS Email Automation

# Protocols
protocols = imap pop3 lmtp
listen = *, ::

# Mail location
mail_location = maildir:/var/mail/vhosts/%d/%n
mail_privileged_group = mail

# SSL configuration
ssl = required
ssl_cert = </etc/letsencrypt/live/mail.{domain}/fullchain.pem
ssl_key = </etc/letsencrypt/live/mail.{domain}/privkey.pem
ssl_protocols = !SSLv3 !TLSv1 !TLSv1.1
ssl_cipher_list = ECDH+AESGCM:ECDH+CHACHA20:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:RSA+AESGCM:RSA+AES:!aNULL:!MD5:!DSS
ssl_prefer_server_ciphers = yes

# Authentication
auth_mechanisms = plain login
disable_plaintext_auth = yes

# Mailbox settings
namespace inbox {{
  type = private
  separator = /
  prefix = INBOX/
  inbox = yes
  
  mailbox Drafts {{
    special_use = \Drafts
  }}
  mailbox Junk {{
    special_use = \Junk
  }}
  mailbox Trash {{
    special_use = \Trash
  }}
  mailbox Sent {{
    special_use = \Sent
  }}
}}

# Quota settings
plugin {{
  quota = maildir:User quota
  quota_rule = *:storage=1GB
  quota_rule2 = Trash:storage=+100M
  quota_warning = storage=95%% quota-warning 95 %u
  quota_warning2 = storage=80%% quota-warning 80 %u
}}

# Password and user database
passdb {{
  driver = sql
  args = /etc/dovecot/dovecot-sql.conf.ext
}}

userdb {{
  driver = sql
  args = /etc/dovecot/dovecot-sql.conf.ext
}}

# Service configuration
service auth {{
  unix_listener /var/spool/postfix/private/auth {{
    mode = 0666
    user = postfix
    group = postfix
  }}
  
  unix_listener auth-userdb {{
    mode = 0600
    user = vmail
    group = vmail
  }}
  
  user = dovecot
}}

service auth-worker {{
  user = vmail
}}

service imap-login {{
  inet_listener imap {{
    port = 143
  }}
  inet_listener imaps {{
    port = 993
    ssl = yes
  }}
  
  process_min_avail = 0
  process_limit = 100
}}

service pop3-login {{
  inet_listener pop3 {{
    port = 110
  }}
  inet_listener pop3s {{
    port = 995
    ssl = yes
  }}
}}

service lmtp {{
  unix_listener /var/spool/postfix/private/dovecot-lmtp {{
    mode = 0600
    user = postfix
    group = postfix
  }}
}}

# Protocol settings
protocol imap {{
  mail_plugins = $mail_plugins quota imap_quota
}}

protocol pop3 {{
  mail_plugins = $mail_plugins quota
}}

protocol lmtp {{
  mail_plugins = $mail_plugins quota
}}

# Logging
mail_debug = no
auth_debug = no
verbose_ssl = no

# Performance tuning
default_process_limit = 100
default_client_limit = 1000
default_vsz_limit = 256M

# IMAP settings
imap_client_workarounds = delay-newmail tb-extra-mailbox-sep
imap_idle_notify_interval = 2 mins

# POP3 settings
pop3_client_workarounds = outlook-no-nuls oe-ns-eoh
